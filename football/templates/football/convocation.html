{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Convocatoria · {{ team_name }}</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root {
        --bg: #020617;
        --panel: rgba(5, 10, 31, 0.95);
        --panel-strong: rgba(10, 15, 45, 0.9);
        --accent: #ffb703;
        --accent-muted: rgba(255, 183, 3, 0.4);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: 'Inter', system-ui, sans-serif;
        background: radial-gradient(circle at top, rgba(255, 255, 255, 0.08), transparent 40%), var(--bg);
        color: #f8fafc;
        min-height: 100vh;
      }
      .page {
        min-height: 100vh;
        padding: 0;
      }
      .convocation-screen {
        min-height: 100vh;
        display: grid;
        grid-template-columns: 1fr minmax(280px, 360px);
      }
      .field-column {
        background: linear-gradient(180deg, rgba(1, 6, 14, 0.9), rgba(2, 9, 23, 0.95));
        padding: 2rem;
        display: flex;
        align-items: stretch;
        justify-content: center;
      }
      .field-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
        height: 100%;
      }
      .field-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }
      .field-score {
        border-radius: 14px;
        background: rgba(0, 0, 0, 0.35);
        padding: 0.75rem 1rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.7rem;
      }
      .field-score strong {
        display: block;
        font-size: 0.9rem;
        letter-spacing: 0.2em;
      }
      .field-formation {
        border-radius: 99px;
        background: rgba(255, 255, 255, 0.08);
        padding: 0.4rem 1.1rem;
        font-size: 0.7rem;
        letter-spacing: 0.4em;
      }
      .field-poster {
        flex: 1;
        border-radius: 32px;
        background-image: linear-gradient(180deg, rgba(14, 99, 70, 0.9), rgba(4, 48, 22, 0.95)),
          url({% static 'football/campo-futbol.jpg' %});
        background-size: cover;
        background-position: center;
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 35px 80px rgba(0, 0, 0, 0.55), inset 0 0 40px rgba(0, 0, 0, 0.35);
        position: relative;
        overflow: hidden;
      }
      .field-overlay {
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 40% 30%, rgba(255, 255, 255, 0.12), transparent 45%),
          linear-gradient(180deg, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.45));
        pointer-events: none;
      }
      .convocation-slots-panel {
        display: none;
      }
      .convocation-sidebar {
        background: rgba(5, 10, 31, 0.95);
        border-left: 1px solid rgba(255, 255, 255, 0.05);
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
      }
      .sidebar-header h1 {
        margin: 0;
        font-size: 1.8rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
      }
      .sidebar-header p {
        margin: 0.4rem 0 0;
        color: rgba(248, 250, 252, 0.6);
        font-size: 0.85rem;
      }
      .convocation-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      .button {
        border: none;
        border-radius: 999px;
        padding: 0.85rem 1.8rem;
        background: linear-gradient(135deg, #ffb703, #f97316);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        cursor: pointer;
      }
      .button.ghost {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--accent);
      }
      .convocation-message {
        font-size: 0.85rem;
        color: rgba(16, 185, 129, 0.9);
      }
      .slot-description {
        margin: 0;
        font-size: 0.75rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: rgba(248, 250, 252, 0.6);
      }
      .convocation-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .convocation-list li {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 0.75rem 1rem;
      }
      .convocation-list li strong {
        display: block;
        letter-spacing: 0.08em;
      }
      .convocation-list li span {
        display: block;
        font-size: 0.7rem;
        letter-spacing: 0.25em;
        color: rgba(248, 250, 252, 0.65);
      }
      .player-pool-drawer {
        position: fixed;
        inset: auto 1rem 1rem;
        width: calc(100% - 2rem);
        max-width: 640px;
        height: 38vh;
        background: rgba(4, 8, 25, 0.95);
        border-radius: 1.2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        transform: translateY(110%);
        transition: transform 0.35s ease;
        display: flex;
        flex-direction: column;
        padding: 1.25rem;
        gap: 0.75rem;
        z-index: 30;
      }
      .player-pool-drawer.open {
        transform: translateY(0);
      }
      .player-pool-drawer header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .player-pool-drawer h3 {
        margin: 0;
        letter-spacing: 0.2em;
        text-transform: uppercase;
      }
      .player-pool-drawer p {
        margin: 0.35rem 0 0;
        color: rgba(248, 250, 252, 0.6);
        font-size: 0.8rem;
        letter-spacing: 0.1em;
      }
      .drawer-close {
        border: none;
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.9);
        padding: 0.4rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
      }
      .mini-cards {
        margin-top: 0.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        overflow-y: auto;
        padding-right: 0.5rem;
      }
      .mini-card {
        width: 150px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.07), rgba(12, 46, 93, 0.8));
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 18px;
        padding: 0.8rem 0.9rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.35rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        cursor: grab;
      }
      .mini-card:focus-visible,
      .mini-card:hover {
        outline: none;
        transform: translateY(-4px);
      }
      .jersey-number {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--accent);
      }
      .player-name {
        font-size: 0.95rem;
        font-weight: 600;
      }
      .position-label {
        font-size: 0.65rem;
        color: rgba(248, 250, 252, 0.65);
      }
      .convocation-slot {
        width: 84px;
        height: 68px;
        border-radius: 16px;
        border: 2px dashed rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(248, 250, 252, 0.5);
        letter-spacing: 0.3em;
        font-size: 0.6rem;
      }
      .convocation-slot.drag-over,
      .convocation-slot.has-card {
        border-color: rgba(255, 183, 3, 0.9);
      }
      @media (max-width: 1024px) {
        .convocation-screen {
          grid-template-columns: 1fr;
        }
        .convocation-sidebar {
          position: relative;
          border-left: none;
          border-top: 1px solid rgba(255, 255, 255, 0.08);
        }
        .player-pool-drawer {
          width: calc(100% - 2rem);
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="convocation-screen">
        <section class="field-column">
          <div class="field-area">
            <div class="field-header">
              <div class="field-score">
                <strong>{{ team_name }} · TITULAR</strong>
                HOME · LINEUPS
              </div>
              <div class="field-formation">3-5-2</div>
            </div>
            <div class="field-poster">
              <div class="field-overlay"></div>
            </div>
            <div class="convocation-slots-panel">
              <h3>Convocatoria</h3>
              <p class="slot-description">Haz clic en la plantilla o arrástrala al campo.</p>
              <div class="slots-grid">
                <div class="convocation-slot" data-slot="convocado-01" data-label="1"></div>
                <div class="convocation-slot" data-slot="convocado-02" data-label="2"></div>
                <div class="convocation-slot" data-slot="convocado-03" data-label="3"></div>
                <div class="convocation-slot" data-slot="convocado-04" data-label="4"></div>
                <div class="convocation-slot" data-slot="convocado-05" data-label="5"></div>
                <div class="convocation-slot" data-slot="convocado-06" data-label="6"></div>
                <div class="convocation-slot" data-slot="convocado-07" data-label="7"></div>
                <div class="convocation-slot" data-slot="convocado-08" data-label="8"></div>
                <div class="convocation-slot" data-slot="convocado-09" data-label="9"></div>
                <div class="convocation-slot" data-slot="convocado-10" data-label="10"></div>
                <div class="convocation-slot" data-slot="convocado-11" data-label="11"></div>
                <div class="convocation-slot" data-slot="convocado-12" data-label="12"></div>
                <div class="convocation-slot" data-slot="convocado-13" data-label="13"></div>
                <div class="convocation-slot" data-slot="convocado-14" data-label="14"></div>
                <div class="convocation-slot" data-slot="convocado-15" data-label="15"></div>
              </div>
            </div>
          </div>
        </section>
        <aside class="convocation-sidebar">
          <div class="sidebar-header">
            <div>
              <h1>Convocatoria</h1>
              <p>Lista flexible sincronizada con el campo.</p>
            </div>
            <button id="pool-toggle" class="button ghost" type="button">Plantilla</button>
          </div>
          <div class="convocation-actions">
            <button id="save-convocation" class="button" type="button">Guardar convocatoria</button>
            <span id="convocation-message" class="convocation-message"></span>
          </div>
          <h3>Listado convocados</h3>
          <p class="slot-description">Se rellenan automáticamente con cada jugador que pases al campo.</p>
          <ul id="convocation-list" class="convocation-list">
            <li class="convocation-empty">Todavía no has definido el once inicial.</li>
          </ul>
        </aside>
      </div>
    </div>
    <section class="player-pool-drawer" id="player-pool-drawer">
      <header>
        <div>
          <h3>Plantilla disponible</h3>
          <p>Arrastra o pulsa para añadir jugadores.</p>
        </div>
        <button id="close-pool" class="drawer-close" type="button">Cerrar</button>
      </header>
      <div class="mini-cards">
        {% for player in players %}
        <div
          class="mini-card"
          draggable="true"
          data-player-id="{{ player.id }}"
          data-player-name="{{ player.name|escape }}"
          data-player-number="{{ player.number|default:'--' }}"
          data-player-position="{{ player.position|default:'Sin definir'|escape }}"
        >
          <div class="jersey-number">#{{ player.number|default:"--" }}</div>
          <div class="player-name">{{ player.name }}</div>
          <div class="position-label">{{ player.position|default:"Sin definir" }}</div>
        </div>
        {% endfor %}
        {% if not players %}
        <p>No hay jugadores registrados todavía.</p>
        {% endif %}
      </div>
    </section>
    <script>
      const pool = document.querySelector('.mini-cards');
      const cards = document.querySelectorAll('.mini-card');
      const fieldPoster = document.querySelector('.field-poster');
      const convocationSlots = document.querySelectorAll('.convocation-slot');
      const convocationList = document.querySelector('#convocation-list');
      const saveButton = document.querySelector('#save-convocation');
      const messageEl = document.querySelector('#convocation-message');
      const drawer = document.querySelector('#player-pool-drawer');
      const poolToggle = document.querySelector('#pool-toggle');
      const closePool = document.querySelector('#close-pool');
      const convocationSet = new Set();

      const getCookie = (name) => {
        const matches = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return matches ? decodeURIComponent(matches[2]) : '';
      };

      const showMessage = (text, isError = false) => {
        messageEl.textContent = text || '';
        messageEl.style.color = isError ? 'rgba(248, 113, 113, 0.9)' : 'rgba(16, 185, 129, 0.9)';
      };

      const addToConvocation = (card) => {
        if (card) {
          convocationSet.add(card.dataset.playerId);
          updateConvocationList();
        }
      };

      const removeFromConvocation = (card) => {
        if (card) {
          convocationSet.delete(card.dataset.playerId);
          updateConvocationList();
        }
      };

      const updateConvocationList = () => {
        const entries = Array.from(convocationSet)
          .map((playerId) => document.querySelector(`.mini-card[data-player-id="${playerId}"]`))
          .filter(Boolean)
          .map((card) => ({
            number: card.dataset.playerNumber || '--',
            name: card.dataset.playerName || card.innerText,
            position: card.dataset.playerPosition || 'Sin definir',
          }));

        convocationList.innerHTML = '';
        if (!entries.length) {
          const empty = document.createElement('li');
          empty.className = 'convocation-empty';
          empty.textContent = 'Todavía no has definido el once inicial.';
          convocationList.appendChild(empty);
          return;
        }

        entries.forEach(({ number, name, position }) => {
          const item = document.createElement('li');
          item.innerHTML = `<strong>#${number} ${name}</strong><span>${position}</span>`;
          convocationList.appendChild(item);
        });
      };

      const placeCardOnField = (card, x, y) => {
        const parentSlot = card.closest('.convocation-slot');
        if (parentSlot) {
          parentSlot.classList.remove('has-card');
          parentSlot.innerHTML = '';
        }
        card.style.position = 'absolute';
        card.style.left = `${x}px`;
        card.style.top = `${y}px`;
        card.style.transform = 'translate(-50%, -50%)';
        card.style.zIndex = 2;
        fieldPoster.appendChild(card);
        addToConvocation(card);
      };

      const resetCardStyles = (card) => {
        card.style.position = '';
        card.style.left = '';
        card.style.top = '';
        card.style.transform = '';
        card.style.zIndex = '';
      };

      const fillNextConvSlot = (card) => {
        const target = Array.from(convocationSlots).find((slot) => !slot.querySelector('.mini-card'));
        if (target) {
          target.appendChild(card);
          target.classList.add('has-card');
          resetCardStyles(card);
          addToConvocation(card);
        }
      };

      const bindConvSlot = (slot) => {
        slot.addEventListener('dragover', (event) => {
          event.preventDefault();
          slot.classList.add('drag-over');
        });
        slot.addEventListener('dragleave', () => {
          slot.classList.remove('drag-over');
        });
        slot.addEventListener('drop', (event) => {
          event.preventDefault();
          slot.classList.remove('drag-over');
          const playerId = event.dataTransfer.getData('text/plain');
          const card = document.querySelector(`.mini-card[data-player-id="${playerId}"]`);
          if (!card) {
            return;
          }
          if (slot.querySelector('.mini-card')) {
            const existing = slot.querySelector('.mini-card');
            pool.appendChild(existing);
            removeFromConvocation(existing);
          }
          slot.appendChild(card);
          slot.classList.add('has-card');
          resetCardStyles(card);
          addToConvocation(card);
        });
      };

      const handleFieldDrop = (event) => {
        event.preventDefault();
        const playerId = event.dataTransfer.getData('text/plain');
        const card = document.querySelector(`.mini-card[data-player-id="${playerId}"]`);
        if (!card) {
          return;
        }
        const rect = fieldPoster.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        placeCardOnField(card, x, y);
      };

      const saveConvocation = async () => {
        if (!convocationSet.size) {
          showMessage('Añade jugadores antes de guardar.', true);
          return;
        }
        const response = await fetch('{% url "convocation-save" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify(Array.from(convocationSet)),
        });
        const payload = await response.json();
        if (response.ok) {
          showMessage(`Convocatoria guardada (${payload.count} jugadores).`);
        } else {
          showMessage(payload.error || 'No se pudo guardar la convocatoria.', true);
        }
      };

      const openDrawer = () => drawer?.classList.add('open');
      const closeDrawer = () => drawer?.classList.remove('open');

      cards.forEach((card) => {
        card.addEventListener('dragstart', (event) => {
          card.classList.add('dragging');
          event.dataTransfer.setData('text/plain', card.dataset.playerId);
          event.dataTransfer.effectAllowed = 'move';
        });
        card.addEventListener('dragend', () => {
          card.classList.remove('dragging');
        });
        card.addEventListener('click', () => {
          if (!pool.contains(card)) {
            return;
          }
          fillNextConvSlot(card);
        });
      });

      fieldPoster.addEventListener('dragover', (event) => {
        event.preventDefault();
      });
      fieldPoster.addEventListener('drop', handleFieldDrop);

      pool.addEventListener('dragover', (event) => {
        try {
          event.preventDefault();
        } catch (error) {
          console.error(error);
        }
      });
      pool.addEventListener('drop', (event) => {
        event.preventDefault();
        const playerId = event.dataTransfer.getData('text/plain');
        const card = document.querySelector(`.mini-card[data-player-id="${playerId}"]`);
        if (!card) {
          return;
        }
        const originSlot = card.closest('.convocation-slot');
        if (originSlot) {
          originSlot.classList.remove('has-card');
        }
        removeFromConvocation(card);
        resetCardStyles(card);
        pool.appendChild(card);
      });

      saveButton.addEventListener('click', saveConvocation);
      poolToggle?.addEventListener('click', openDrawer);
      closePool?.addEventListener('click', closeDrawer);
      drawer?.addEventListener('click', (event) => {
        if (event.target === drawer) {
          closeDrawer();
        }
      });

      convocationSlots.forEach(bindConvSlot);

      updateConvocationList();
    </script>
  </body>
</html>
